{% extends "base.html" %}

{% block body %}
<div class="form-section">
    <h1>Tell Us Your Story</h1>
    <p class="subtitle">Share your memories and let them live forever in the Museum of Hearts</p>

    <form method="POST" action="{{ url_for('create') }}" class="story-form" enctype="multipart/form-data">
        <label for="to_name">To:</label>
        <input type="text" id="to_name" name="to_name" placeholder="Recipient's name" required>

        <label for="location">Location:</label>
        <input type="text" id="location" name="location" placeholder="e.g. FCM Cinema" required>

        <!-- Hidden latitude & longitude -->
        <input type="hidden" name="lat" id="lat" value="{{ pre_lat or '' }}">
        <input type="hidden" name="lng" id="lng" value="{{ pre_lng or '' }}">

        <div id="map2" style="height: 200px; width: 150; margin-top: 20px;"></div>

        <label for="message">Message:</label>
        <textarea id="message" name="message" rows="5" placeholder="What would you like them to know?..." required></textarea>

        <!-- Spotify Song Search -->
        <label for="songSearch">Search for a Spotify Song (Required):</label>
        <div class="song-search-container">
            <input type="text" id="songSearch" placeholder="Type a song name...">
            <button type="button" onclick="searchSong()">Search</button>
        </div>
        <div id="results" class="song-results"></div>
        <p id="chosenSong" class="chosen-song"></p>
        <input type="hidden" id="song" name="song" required>

        <!-- Optional attachments -->
        <label for="photos">Attach Photos (Optional, up to 6)</label>
        <input type="file" id="photos" name="photos" accept="image/*" multiple>

        <label for="video">Attach Video (Optional)</label>
        <input type="file" id="video" name="video" accept="video/*">

        <label for="from_name">From (Optional)</label>
        <input type="text" id="from_name" name="from_name" placeholder="You can stay anonymous :D">

        <button type="submit" class="btn-submit">ðŸ’Œ Submit Story</button>
    </form>
</div>


<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

    // Initialize map
    const map = L.map('map2').setView([2.9273, 101.6415], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    minZoom: 15, // optional: keep users zoomed in close to MMU
    attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Define bounds
    const bounds = L.latLngBounds(
    [2.9230, 101.6360], // Southwest corner
    [2.9310, 101.6460]  // Northeast corner
    );

    // Lock map to bounds
    map.setMaxBounds(bounds);

    // Small trick: when the map first loads, this prevents users 
    // from dragging it out before the restriction kicks in
    map.on('drag', function () {
    map.panInsideBounds(bounds, { animate: false });
    });


    var marker;

    // On map click: add marker, update lat/lng, and fetch location name
    map.on('click', function(e) {
    var lat = e.latlng.lat;
    var lng = e.latlng.lng;

    // Place or move marker
    if (marker) {
        marker.setLatLng(e.latlng);
    } else {
        marker = L.marker(e.latlng).addTo(map);
    }

    // Update hidden fields
    document.getElementById('lat').value = lat;
    document.getElementById('lng').value = lng;

    // Fetch short faculty name from Flask
    fetch("/location", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `lat=${lat}&lng=${lng}`}).then(response => response.json()).then(data => {
        document.getElementById('location').value = data.faculty_code; // short name
    })

    .catch(err => console.log(err));
    });

    // Display coordinates if pre-filled
    if (document.getElementById('lat').value && document.getElementById('lng').value) {
        const lat = document.getElementById('lat').value;
        const lng = document.getElementById('lng').value;
        const el = document.createElement('p');
        el.innerHTML = `<small>Memory will be placed at: <strong>${lat}, ${lng}</strong></small>`;
        document.querySelector('.form-section').insertBefore(el, document.querySelector('.form-section').children[1]);
    }


    // Spotify search
    async function searchSong() {
        const query = document.getElementById("songSearch").value;
        if (!query) return alert("Type a song name first!");

        const res = await fetch(`/search?q=${encodeURIComponent(query)}`);
        const data = await res.json();

        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = "";

        if (data.tracks && data.tracks.items.length > 0) {
            data.tracks.items.forEach(track => {
                const div = document.createElement("div");
                div.style.cursor = "pointer";
                div.style.margin = "10px 0";
                div.innerHTML = `
                    <img src="${track.album.images[2]?.url}" width="50" style="vertical-align:middle;">
                    <strong>${track.name}</strong> â€” ${track.artists.map(a => a.name).join(", ")}
                `;

                div.onclick = () => {
                    document.getElementById("song").value = track.external_urls.spotify;
                    document.getElementById("chosenSong").innerText =
                        `Selected: ${track.name} â€” ${track.artists.map(a => a.name).join(", ")}`;
                };

                resultsDiv.appendChild(div);
            });
        } else {
            resultsDiv.innerText = "No results found.";
        }
    }
</script>
{% endblock %}
