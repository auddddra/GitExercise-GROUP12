{% extends "base.html" %}
{% block body %}

<!-- top login/register button above header -->
<div class="user-button">
    {% if session.get("user_id") %}
    <!-- show profile button when logged in -->
    <a href="{{ url_for('profile') }}" class="btn">
        ðŸ‘¤ {{ session.get("username", "Profile") }}
    </a>
    <a href="{{ url_for('logout') }}" class="btn">Logout</a>
  {% else %}
    <!-- show login button if not logged in -->
    <a href="{{ url_for('login') }}" class="btn">Login/Register</a>
  {% endif %}
</div>

<div class="header-section">
    <h1>Museum of Hearts</h1>
    <p>Memories at every spot in Multimedia University</p>

    <div class="header-actions">
        <form method="get" action="{{ url_for('index') }}" class="search-form">
            <input type="text" name="q" placeholder="Search their names" value="{{ search_query }}">
            <button type="submit">Search</button>
        </form>
        <a href="{{ url_for('admin_dashboard') }}" class="btn-outline">ðŸ’Œ admin</a>
        <a href="{{ url_for('create') }}" class="btn-outline">ðŸ’Œ Tell us your story</a>
    </div>
</div>

<div id="map"></div>

<div class="gallery">
    {% if not search_query %}
    <!-- Demo cards only appear if there is no search query -->
    <div class="card">
        <h3>To: Aisyah</h3>
        <h4 class="location">The Bridge Near FOM</h4>
        <p>I always stopped here after class with my best friend.</p>
        <iframe style="border-radius:12px" 
            src="https://open.spotify.com/embed/track/5k38wzpLb15YgncyWdTZE4" 
            width="100%" height="80" frameborder="0" 
            allowtransparency="true" allow="encrypted-media">
        </iframe>
    </div>

    <div class="card">
        <h3>To: Melissa</h3>
        <h4 class="location">Library Steps</h4>
        <p>Where I met you for the first time.</p>
        <iframe style="border-radius:12px" 
            src="https://open.spotify.com/embed/track/0tgVpDi06FyKpA1z0VMD4v" 
            width="100%" height="80" frameborder="0" 
            allowtransparency="true" allow="encrypted-media">
        </iframe>
    </div>

        <div class="card">
        <h3>To: Michael</h3>
        <h4 class="location">Haji tapah</h4>
        <p>my favourite memroy of us will always be at here.</p>
        <iframe style="border-radius:12px" 
            src="https://open.spotify.com/embed/track/3ZCTVFBt2Brf31RLEnCkWJ" 
            width="100%" height="80" frameborder="0" 
            allowtransparency="true" allow="encrypted-media">
        </iframe>
    </div>
    {% endif %}

    <!-- User-submitted cards -->
    {% for card in cards %}
        <div class="card" data-card-id="{{ card.id }}">
            <h3>To: {{ card.to_name }}</h3>
            <h4 class="location">{{ card.location }}</h4>
            <p>{{ card.message }}</p>
            {% if card.song %}
                <iframe src="https://open.spotify.com/embed/track/{{ card.song.split('/')[-1] }}"
                        width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                </iframe>
            {% endif %}
            <a href="{{ url_for('view_card', card_id=card.id) }}">View full memory â†’</a>
        </div>
    {% endfor %}
</div>

<script>
    // Initialize map
    const map = L.map('map').setView([2.9273, 101.6415], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    minZoom: 15, // optional: keep users zoomed in close to MMU
    attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Define bounds
    const bounds = L.latLngBounds(
    [2.9230, 101.6360], // Southwest corner
    [2.9310, 101.6460]  // Northeast corner
    );

    // Lock map to bounds
    map.setMaxBounds(bounds);

    // Small trick: when the map first loads, this prevents users 
    // from dragging it out before the restriction kicks in
    map.on('drag', function () {
    map.panInsideBounds(bounds, { animate: false });
    });


    // Map cards passed from Flask
    const mapCards = {{ map_cards|tojson }};

    const markers = {};
    mapCards.forEach(card => {
        const marker = L.circleMarker([card.lat, card.lng], {
            radius: 6,
            fillColor: '#e380b0',
            color: '#e380b0',
            fillOpacity: 0.9,
            weight: 0
        }).addTo(map);

        marker.bindPopup(`
            <div style="min-width:220px">
                <strong>To: ${card.to_name}</strong><br>
                <small>${card.location}</small>
                <p style="margin:6px 0;">${card.message.slice(0,120)}${card.message.length>120?'â€¦':''}</p>
                <div style="text-align:right;"><a href="/card/${card.id}">View full memory â†’</a></div>
            </div>
        `);

        markers[card.id] = marker;
    });

    // Hover effect
    document.querySelectorAll('.card[data-card-id]').forEach(el => {
        const id = el.getAttribute('data-card-id');
        el.addEventListener('mouseenter', () => {
            const m = markers[id];
            if (m && m.setRadius) m.setRadius(12);
        });
        el.addEventListener('mouseleave', () => {
            const m = markers[id];
            if (m && m.setRadius) m.setRadius(6);
        });
    });

    // Add memory on right-click
    map.on('contextmenu', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        const html = `<a href="/create?lat=${lat}&lng=${lng}" style="text-decoration:none;color:#e380b0;font-weight:600;">ðŸ’Œ Leave a memory here</a>`;
        L.popup({ closeButton: true }).setLatLng(e.latlng).setContent(html).openOn(map);
    });
</script>

{% endblock %}




