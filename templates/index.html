<!--inherits from base.html-->
{% extends "base.html" %}

{% block body %}
<div class="header-section">
    <h1>Museum of Hearts</h1>
    <p>memories and untold feelings at every spot in Multimedia University</p>

    <div class="header-actions">
        <form method="GET" action="{{ url_for('index') }}" class="search-form">
            <input type="search" name="q" placeholder="Search name or place..." value="{{ request.args.get('q', '') }}">
            <button type="submit">üîç</button>
        </form>

        <a href="{{ url_for('create') }}" class="btn-outline"> üíå Tell us your story</a>
    </div>
</div>

<div id="map"></div>
    

<script>
    var map = L.map('map', {
    center: [2.9273, 101.6415],
    zoom: 16,

    });

    var mapbounds = [
        [2.9215, 101.6370], 
        [2.9325, 101.6465]
    ];
    map.setMaxBounds(mapbounds);          
    map.setView([2.9273, 101.6415], 17);  
    map.options.maxBoundsViscosity = 1.0;

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    function addMarker(lat, lng, label) {
      L.marker([lat, lng]).addTo(map)
        .bindPopup("<b>" + label + "</b><br>(" + lat.toFixed(5) + ", " + lng.toFixed(5) + ")");
    }

    // Save pins locally in browser
    var pins = JSON.parse(localStorage.getItem("pins")) || [];

    // Load existing pins
    pins.forEach(pin => addMarker(pin.lat, pin.lng, pin.label));

    // add custom pins on right-click

    map.on('contextmenu', function(e) {
    var label = prompt("Enter a label for your pin:");
    if (label) {
        
        L.marker([e.latlng.lat, e.latlng.lng]).addTo(map)
            .bindPopup("<b>" + label + "</b><br>(" + e.latlng.lat.toFixed(5) + ", " + e.latlng.lng.toFixed(5) + ")");

        fetch("/api/pins", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat: e.latlng.lat, lng: e.latlng.lng, label: label })
        })
        .then(res => res.json())
        .then(data => console.log("Pin saved:", data))
        .catch(err => console.error("Error saving pin:", err));
    }
    });

    fetch("/api/pins")
    .then(res => res.json())
    .then(pins => {
        pins.forEach(pin => {
            L.marker([pin.lat, pin.lng]).addTo(map)
                .bindPopup("<b>" + pin.label + "</b>");
        });
    });


</script>


<div class="gallery">
    {% for card in cards %}
        <div class="card">
            <h3>To: {{ card.to_name }}</h3>
            <h4 class="location">{{ card.location }}</h4>
            <p class="message">{{ card.message }}</p>

            <!-- {% if card.song %}
                <iframe style="border-radius:12px"
                    src="{{ card.song | replace('open.spotify.com/track', 'open.spotify.com/embed/track') }}" width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                </iframe>
            {% endif %} -->

            {% if card.photo %}
                <img src="{{ url_for('static', filename=card.photo.split('static/')[-1]) }}" alt="Uploaded photo" width="100%">
            {% endif %}

            {% if card.video %}
                <video width="100%" controls>
                    <source src="{{ url_for('static', filename=card.video.split('static/')[-1]) }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            {% endif %}

            {% if card.from_name %}
                <p class="from">From: {{ card.from_name }}</p>
            {% endif %}
        </div>
    {% endfor %}
</div>
{% endblock %}


{% block footer %}
<div class="footer">
    <a href="{{ url_for('contacts') }}" target="_self">Contact us for help</a>
</div>
{% endblock %}