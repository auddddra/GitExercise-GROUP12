{% extends "base.html" %}

{% block body %}
<h1 class="admin-title">Admin Dashboard</h1>

<div class="back-btn-container">
    <a href="{{ url_for('index') }}" class="back-btn">← Back to Gallery</a>
</div>
        
<div id="map"></div>

<div class="dashboard">

    <div class="section">
        <h2>Pending Cards</h2>
        {% for card in pending %}
        <div class="admin-card">
            <h3>To: {{ card.to_name }}</h3>
            <h4 class="location">{{ card.location }}</h4>
            <p>{{ card.message }}</p>
            {% if card.song %}
                <iframe src="https://open.spotify.com/embed/track/{{ card.song.split('/')[-1] }}"
                        width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                </iframe>
            {% endif %}
            <a href="{{ url_for('view_card', card_id=card.id) }}">View full memory →</a>

            <form action="{{ url_for('approve_card', card_id=card.id) }}" method="post" style="display:inline;">
                <button type="submit">Approve</button>
            </form>

            <form action="{{ url_for('reject_card', card_id=card.id) }}" method="post" style="display:inline;">
                <button type="submit">Reject</button>
            </form>
        </div>
        {% endfor %}
    </div>

    <div class="section">
        <h2>Approved Cards</h2>
        {% for card in approved %}
            <div class="admin-card">
                <h3>To: {{ card.to_name }}</h3>
                <h4 class="location">{{ card.location }}</h4>
                <p>{{ card.message }}</p>
                {% if card.song %}
                    <iframe src="https://open.spotify.com/embed/track/{{ card.song.split('/')[-1] }}"
                            width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                    </iframe>
                {% endif %}
                <a href="{{ url_for('view_card', card_id=card.id) }}">View full memory →</a>

                <form action="{{ url_for('archive_card', card_id=card.id) }}" method="post" style="display:inline;">
                    <button type="submit">Archive</button>
                </form>

                <form action="{{ url_for('edit_card', card_id=card.id) }}" method="get" style="display:inline;">
                    <button type="submit">Edit</button>
                </form>
            </div>
        {% endfor %}
    </div>

    <div class="section">
        <h2>Rejected Cards</h2>
        {% for card in rejected %}
        <div class="admin-card" id="card-{{ card.id }}">
            <h3>To: {{ card.to_name }}</h3>
            <h4 class="location">{{ card.location }}</h4>
            <p>{{ card.message }}</p>
            {% if card.song %}
                <iframe src="https://open.spotify.com/embed/track/{{ card.song.split('/')[-1] }}"
                        width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                </iframe>
            {% endif %}
            <a href="{{ url_for('view_card', card_id=card.id) }}">View full memory →</a>

            <form action="{{ url_for('delete_card', card_id=card.id) }}" method="POST" style="display:inline;">
                <button type="submit"
                    onclick="return confirm('Are you sure you want to delete this card? This cannot be undone.')">
                    Delete
                </button>
            </form>
        </div>
        {% endfor %}
    </div>

    <div class="section">
        <h2>Archived Cards</h2>
        {% for card in archived %}
        <div class="admin-card" id="card-{{ card.id }}">
            <h3>To: {{ card.to_name }}</h3>
            <h4 class="location">{{ card.location }}</h4>
            <p>{{ card.message }}</p>
            {% if card.song %}
                <iframe src="https://open.spotify.com/embed/track/{{ card.song.split('/')[-1] }}"
                        width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                </iframe>
            {% endif %}
            <a href="{{ url_for('view_card', card_id=card.id) }}">View full memory →</a>

            <!-- DELETE button -->
            <form action="{{ url_for('delete_card', card_id=card.id) }}" method="POST" style="display:inline;">
                <button type="submit"
                    onclick="return confirm('Are you sure you want to delete this card? This cannot be undone.')">
                    Delete
                </button>
            </form>
        </div>
        {% endfor %}
    </div>
</div>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    
    const map = L.map('map').setView([2.9264, 101.6411], 16); // MMU
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    function addMarkers(cards, color) {
        cards.forEach(card => {
            if (card.lat && card.lng) {
                const marker = L.circleMarker([card.lat, card.lng], {
                    color: color,
                    radius: 8,
                    fillOpacity: 0.9
                }).addTo(map);

                marker.bindPopup(`<b>${card.to_name}</b><br>${card.message}`);
            }
        });
    }

    const pendingCards = {{ pending|tojson }};
    const approvedCards = {{ approved|tojson }};
    const rejectedCards = {{ rejected|tojson }};
    const archivedCards = {{ archived|tojson }};

    function addMarkers(cards, color) {
        cards.forEach(card => {
            if (card.lat && card.lng) {
                const marker = L.circleMarker([card.lat, card.lng], {
                    color: color,
                    radius: 8,
                    fillOpacity: 0.9
                }).addTo(map);

                marker.bindPopup(`<b>${card.to_name}</b><br>${card.message}`);
            }
        });
    }

    addMarkers(pendingCards, "yellow");
    addMarkers(approvedCards, "pink");
    addMarkers(rejectedCards, "red");
    addMarkers(archivedCards, "blue");
</script>

<h2 class="admin-title"> Report Dashboard </h2>
<table border="1" width="100%" cellpadding="10" cellspacing="0">
    <thead>
        <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Cards Posted</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for u in user_data %}
            <tr onclick="window.location='{{ url_for('view_user_profile', user_id=u.id) }}'">
                <td>{{ u.username }}</td>
                <td>{{ u.email }}</td>
                <td>{{ u.total_cards }}</td>
                <td>
                    <form action="{{ url_for('admin_delete_user', user_id=u.id) }}" method="POST"
                        style="display:inline;"
                        onsubmit="return confirm('Are you sure you want to delete this user? This action cannot be undone.');"
                        onclick="event.stopPropagation();">
                        <button type="submit">Delete</button>
                    </form>


                </td>
            </tr>
        {% endfor %}

    </tbody>
</table>



{% endblock %}


