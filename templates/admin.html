{% extends "base.html" %}

{% block body %}
<h1 class="text-center">Admin Dashboard</h1>

<div class="back-btn-container">
            <a href="{{ url_for('index') }}" class="back-btn">← Back to Gallery</a>
        </div>
        
<div id="map"></div>

<div class="dashboard">

    <div class="section">
        <h2>Pending Cards</h2>
        {% for card in pending %}
        <div class="admin-card">
            <h3>To: {{ card.to_name }}</h3>
            <h4 class="location">{{ card.location }}</h4>
            <p>{{ card.message }}</p>
            {% if card.song %}
                <iframe src="https://open.spotify.com/embed/track/{{ card.song.split('/')[-1] }}"
                        width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                </iframe>
            {% endif %}
            <a href="{{ url_for('view_card', card_id=card.id) }}">View full memory →</a>

            <form action="{{ url_for('approve_card', card_id=card.id) }}" method="post" style="display:inline;">
                <button type="submit">Approve</button>
            </form>

            <form action="{{ url_for('reject_card', card_id=card.id) }}" method="post" style="display:inline;">
                <button type="submit">Reject</button>
            </form>
        </div>
        {% endfor %}
    </div>

    <div class="section">
        <h2>Approved Cards</h2>
        {% for card in approved %}
            <div class="admin-card">
                <h3>To: {{ card.to_name }}</h3>
                <h4 class="location">{{ card.location }}</h4>
                <p>{{ card.message }}</p>
                {% if card.song %}
                    <iframe src="https://open.spotify.com/embed/track/{{ card.song.split('/')[-1] }}"
                            width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                    </iframe>
                {% endif %}
                <a href="{{ url_for('view_card', card_id=card.id) }}">View full memory →</a>

                <form action="{{ url_for('archive_card', card_id=card.id) }}" method="post" style="display:inline;">
                    <button type="submit">Archive</button>
                </form>

                <form action="{{ url_for('edit_card', card_id=card.id) }}" method="get" style="display:inline;">
                    <button type="submit">Edit</button>
                </form>
            </div>
        {% endfor %}
    </div>

    <div class="section">
        <h2>Rejected Cards</h2>
        {% for card in rejected %}
        <div class="admin-card">
            <h3>To: {{ card.to_name }}</h3>
            <h4 class="location">{{ card.location }}</h4>
            <p>{{ card.message }}</p>
            {% if card.song %}
                <iframe src="https://open.spotify.com/embed/track/{{ card.song.split('/')[-1] }}"
                        width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                </iframe>
            {% endif %}
            <a href="{{ url_for('view_card', card_id=card.id) }}">View full memory →</a>
        </div>
        {% endfor %}
    </div>

    <!-- Archived -->
    <div class="section">
        <h2>Archived Cards</h2>
        {% for card in archived %}
        <div class="admin-card">
            <h3>To: {{ card.to_name }}</h3>
            <h4 class="location">{{ card.location }}</h4>
            <p>{{ card.message }}</p>
            {% if card.song %}
                <iframe src="https://open.spotify.com/embed/track/{{ card.song.split('/')[-1] }}"
                        width="100%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media">
                </iframe>
            {% endif %}
            <a href="{{ url_for('view_card', card_id=card.id) }}">View full memory →</a>
        </div>
        {% endfor %}
    </div>
</div>


<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    
    const map = L.map('map').setView([2.9264, 101.6411], 16); // MMU
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    function addMarkers(cards, color) {
        cards.forEach(card => {
            if (card.lat && card.lng) {
                const marker = L.circleMarker([card.lat, card.lng], {
                    color: color,
                    radius: 8,
                    fillOpacity: 0.9
                }).addTo(map);

                marker.bindPopup(`<b>${card.to_name}</b><br>${card.message}`);
            }
        });
    }

    const pendingCards = {{ pending|tojson }};
    const approvedCards = {{ approved|tojson }};
    const rejectedCards = {{ rejected|tojson }};
    const archivedCards = {{ archived|tojson }};

    function addMarkers(cards, color) {
        cards.forEach(card => {
            if (card.lat && card.lng) {
                const marker = L.circleMarker([card.lat, card.lng], {
                    color: color,
                    radius: 8,
                    fillOpacity: 0.9
                }).addTo(map);

                marker.bindPopup(`<b>${card.to_name}</b><br>${card.message}`);
            }
        });
    }

    addMarkers(pendingCards, "yellow");
    addMarkers(approvedCards, "pink");
    addMarkers(rejectedCards, "red");
    addMarkers(archivedCards, "blue");
</script>
{% endblock %}


